/**
 * Created by Anthony on 31/08/2015.
 */
!function(){"use strict";function e(e,t,r,o,a){function i(e,t,r){e.gpu=r,e.hide=function(){t.hide(e.gpu.power)},e.cancel=function(){t.cancel()}}e.user={},e.roi={startDate:new Date,startupFixed:400,startupPerUnit:10,quantity:20},e.series=[{name:"ROI",color:"steelblue",data:[]}],e.options={renderer:"line",min:"auto"},e.features={yAxis:{tickFormat:"unrespected value!"},xAxis:{timeUnit:"month"}},e.series2=[{name:"ROI",color:"steelblue",data:[]}],e.options2={renderer:"line",min:"auto"},e.features2={yAxis:{tickFormat:"unrespected value!"},xAxis:{tickFormat:Rickshaw.Fixtures.Number.formatKMBT}},e.earnings={},e.electricity={price:.09},e.facts={difficulty:0},e.network={diffIncrease:3,linearDiff:!1,blockTime:600,ethPrice:300},e.gpus=[],e.currency=a.NUMBER_FORMATS.CURRENCY_SYM,e.currencies=[{name:"USD",sym:a.NUMBER_FORMATS.CURRENCY_SYM}],e.showSimpleToast=function(e){t.show(t.simple().content(e).position("bottom right").hideDelay(3e3))},e.selectGPU=function(){e.user.gpu.price&&(e.earnings.capitalPerUnit=s(e.user.gpu.name),0===e.earnings.capitalPerUnit&&(e.earnings.capitalPerUnit=e.user.gpu.price),"Cloud"!=e.user.gpu.vendor&&(e.user.electricity=!0)),e.computeEnergyCosts()},e.selectScenario=function(){e.user.gpu="number"==typeof e.user.scenario.asic?e.gpus[e.user.scenario.asic]:e.user.scenario.asic,e.roi=e.user.scenario.roi,e.roi.startDate=new Date(moment(e.user.scenario.roi.startDate,"YYYY-MM-DD")),e.electricity=e.user.scenario.electricity,e.network=e.user.scenario.network,c(e.user.scenario.price),e.selectGPU()},e.saveScenario=function(){var t=localStorage.getItem("cashflow_scenarios");null===t&&(t="[]");var r=JSON.parse(t),o=prompt("Please enter a scenario title","Scenario 1"),a=e.roi;a.startDate=moment(e.roi.startDate).format("YYYY-MM-DD");var i={title:o,type:"user",roi:a,electricity:e.electricity,network:e.network,price:{usd:e.user.price.usd.toString()},asic:{hashrate:e.user.gpu.hashrate,power:e.user.gpu.power,price:e.earnings.capitalPerUnit}};r.push(i),localStorage.setItem("cashflow_scenarios",JSON.stringify(r)),e.myScenarios=r},e.relCycleToDate=function(t){var r=14*t,o=moment(e.roi.startDate).add(r,"days").format("MMM DD YYYY");return o},e.relCycleToEpoch=function(t){var r=moment(e.roi.startDate).unix()+1209600*t;return r},e.cycleEarning=function(t){var r,o=(100+e.network.diffIncrease)/100,a=moment(e.roi.startDate),i=a.diff(moment(),"days"),n=Math.floor(i/14);e.network.linearDiff?(o-=1,r=e.facts.difficulty+e.facts.difficulty*(n+t)*o):r=e.facts.difficulty*Math.pow(o,n+t);var s=e.facts.nowBlock+2016*(n+t),c=50*Math.pow(.5,Math.floor(s/21e4)),u=r*Math.pow(2,32)/(e.user.gpu.hashrate*e.roi.quantity*1e9),l=1209600/u,p=l*c;return p},e.getCycleProfit=function(t,r){var o=336*e.user.gpu.costs,a=e.cycleEarning(t),i=a*r,n={coins:a,costs:o,profit:i-o};return n},e.computeProfits=function(){e.earnings.tab=[];var t=[],r=[];e.earnings.totalStartupCost=e.roi.startupFixed+e.roi.startupPerUnit*e.roi.quantity,e.earnings.initialROI=-1*(e.earnings.capitalPerUnit*e.roi.quantity+e.earnings.totalStartupCost);for(var o=e.earnings.initialROI,a=0;150>a;a++){var i=e.getCycleProfit(a,e.user.price.usd);o+=i.profit,e.earnings.tab.push({label:e.relCycleToDate(a),eth:i.coins,price:i.profit,roi:o});var n=e.relCycleToEpoch(a);if(t.push({x:n,y:o}),r.push({x:n,y:0}),i.profit<0)break}e.series[0]={name:"ROI",color:"steelblue",data:t},e.series[1]={name:"Break-even",color:"lightcoral",data:r},e.computeRoi(),e.computeConvexity(240,800)},e.computeConvexity=function(t,r){for(var o,a=[],i=t;r>=i;i+=10){for(var n=e.earnings.initialROI,s=0;150>s;s++){var c=e.getCycleProfit(s,i);if(c.profit<0)break;n+=c.profit}a.push({x:i,y:n}),void 0===o&&n>0&&(e.series2[1]={name:"Break-even",color:"lightcoral",data:[{x:i,y:e.earnings.initialROI},{x:i,y:0}]},o=i)}e.series2[0]={name:"Price Convexity",color:"steelblue",data:a}},e.loadGPUs=function(){o.get("./assets/json/asics.json").success(function(t){e.gpus=t}).error(function(e,t){console.log("And we just got hit by a "+t+" !!!")})},e.loadScenarios=function(){var t=localStorage.getItem("cashflow_scenarios");null===t&&(t="[]"),e.scenarios=JSON.parse(t),o.get("./assets/json/scenarios.json").success(function(t){e.scenarios=e.scenarios.concat(t)}).error(function(e,t){console.log("And we just got hit by a "+t+" !!!")}),e.loadGPUs()};var n=function(e,t){return t*e/1e3};e.computeEnergyCosts=function(){e.user.gpu&&(e.user.gpu.costs=e.user.electricity&&e.user.gpu.power?n(e.electricity.price,1)*e.user.gpu.power*e.roi.quantity:void 0,e.computeProfits())},e.computeRoi=function(){if(e.earnings.capitalPerUnit){for(var t=0;e.earnings.tab[t].roi<0&&t<e.earnings.tab.length-1;)t++;e.earnings.roiDate=e.earnings.tab[t].roi>=0?e.earnings.tab[t].label:"N/A";var r;r=e.earnings.tab.length>1?e.earnings.tab[e.earnings.tab.length-2]:e.earnings.tab[e.earnings.tab.length-1],e.earnings.totalProfit=r.roi,e.earnings.percentProfit=e.earnings.totalProfit/e.earnings.tab[0].roi*-100,e.earnings.annProfit=365*e.earnings.percentProfit/moment(r.label,"MMM DD YYYY").diff(moment(e.roi.startDate),"days")}};var s=function(e){return 0};e.resetGPU=function(){var t=e.user.gpu.hashrate;e.user.gpu={hashrate:t}},e.init=function(){o.get("https://coinmarketcap-nexuist.rhcloud.com/api/btc").success(function(t){e.facts.market=t,c(t.price)}).error(function(t,r){e.showSimpleToast("Failed to load Network data from coinmarketcap-nexuist.rhcloud.com :-/"),console.log("And we just got hit by a "+r+" !!!")}),o.get("https://blockexplorer.com/api/status?q=getDifficulty").success(function(t){e.facts.difficulty=Math.floor(t.difficulty)}).error(function(t,r){e.showSimpleToast("Failed to load Network data from blockexplorer.com :-/"),console.log("And we just got hit by a "+r+" HTTP status !!!"),e.facts.difficulty=103880340815}),o.get("https://blockexplorer.com/api/status?q=getBlockCount").success(function(t){e.facts.nowBlock=t.blockcount}).error(function(t,r){e.showSimpleToast("Failed to load Network data from blockexplorer.com :-/"),console.log("And we just got hit by a "+r+" HTTP status !!!"),e.facts.nowBlock=1})};var c=function(t){e.user.price={},e.user.price.usd=parseInt(t.usd,10)};e.reset=function(){e.user={},c(e.facts.market.price),e.showSimpleToast("Parameters reset")},e.showAdvanced=function(t){r.show({controller:i,templateUrl:"src/calculator/html/powersupply.tmpl.html",parent:angular.element(document.body),targetEvent:t,clickOutsideToClose:!0,locals:{gpu:e.user.gpu}}).then(function(t){e.user.gpu.power=t,e.computeEnergyCosts(),e.status='You said the information was "'+t+'".'},function(){e.status="You cancelled the dialog."})},i.$inject=["$scope","$mdDialog","gpu"]}angular.module("calculator",["ngMaterial","angular-rickshaw"]),angular.module("calculator").controller("HomeCtrl",e),e.$inject=["$scope","$mdToast","$mdDialog","$http","$locale"]}();